name: Run E2E Tests

on:
  pull_request:
    branches:
      - deploy
      - develop
    types:
      - opened
      - synchronize

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24.0.6
        options: --privileged

    steps:
      # 1. 리포지토리 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. 파이썬 설치
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      # 3. 웹 브라우저 설치 (Chrome, Firefox)
      - name: Install Chrome and ChromeDriver
        run: |
          # Google Chrome 설치
          sudo apt update
          sudo apt install -y wget curl unzip
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb
          # ChromeDriver 설치
          CHROME_DRIVER_VERSION=$(curl -sS https://chromedriver.storage.googleapis.com/LATEST_RELEASE)
          wget https://chromedriver.storage.googleapis.com/$CHROME_DRIVER_VERSION/chromedriver_linux64.zip
          unzip chromedriver_linux64.zip
          sudo mv chromedriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/chromedriver
          google-chrome-stable --version
          chromedriver --version

      - name: Install Firefox and GeckoDriver
        run: |
          # Firefox 설치
          sudo apt install -y firefox
          # GeckoDriver 설치
          FIREFOX_DRIVER_VERSION=$(curl -s https://github.com/mozilla/geckodriver/releases/latest | grep -oP 'v\d+\.\d+\.\d+' | head -n 1)
          wget https://github.com/mozilla/geckodriver/releases/download/$FIREFOX_DRIVER_VERSION/geckodriver-$FIREFOX_DRIVER_VERSION-linux64.tar.gz
          tar -xvzf geckodriver-$FIREFOX_DRIVER_VERSION-linux64.tar.gz
          sudo mv geckodriver /usr/local/bin/
          sudo chmod +x /usr/local/bin/geckodriver
          firefox --version
          geckodriver --version

      # 4. Docker Compose 설치
      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y curl
          DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}
          mkdir -p $DOCKER_CONFIG/cli-plugins
          curl -SL https://github.com/docker/compose/releases/download/v2.32.3/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
          sudo chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          sudo ln -s $DOCKER_CONFIG/cli-plugins/docker-compose /usr/local/bin/docker-compose
          docker-compose version

      # 5. .env.test 생성
      - name: Create .env.test file
        run: |
          echo "MYSQL_DATABASE=${{ secrets.E2E_MYSQL_DATABASE }}" >> .env.test
          echo "MYSQL_ROOT_PASSWORD=${{ secrets.E2E_MYSQL_ROOT_PASSWORD }}" >> .env.test
          echo "MYSQL_USER=${{ secrets.E2E_MYSQL_USER }}" >> .env.test
          echo "MYSQL_PASSWORD=${{ secrets.E2E_MYSQL_PASSWORD }}" >> .env.test
          echo "API_URL=${{ secrets.E2E_API_URL }}" >> .env.test

      # 6. Docker 서비스 시작
      - name: Start Docker
        run: |
          docker-compose -f docker-compose.e2e-test.yml --env-file .env.test up --build -d

      # 7. E2E 테스트를 위한 패키지 설치
      - name: Set up E2E Test Environment
        working-directory: ./e2e-tests
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      # 8. 여러 브라우저로 pytest 실행
      - name: Run E2E Tests
        working-directory: ./e2e-tests
        env:
          BROWSER: ${{ matrix.browser }}
        run: |
          source venv/bin/activate
          pytest --browser $BROWSER

    strategy:
      matrix:
        browser: [chrome, firefox]

